# Base image for NVIDIA Grace Hopper (GH200) Superchip
# Using ARM64 architecture with CUDA for Hopper GPUs
FROM nvidia/cuda:12.2.2-devel-ubuntu22.04

# Prevent interactive prompts during build
ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.11 and pip3
RUN apt update \
    && apt install --fix-missing -y software-properties-common \
    && add-apt-repository -y ppa:deadsnakes/ppa \
    && apt install --fix-missing -y python3.11 python3.11-venv python3.11-dev python3-pip curl vim less openssh-client \
    && rm -f /usr/bin/python /usr/bin/python3 \
    && ln -s $(which python3.11) /usr/bin/python \
    && ln -s $(which python3.11) /usr/bin/python3

# Switch to a non-root user
# Dev containers should substitute for the current user on startup but that doesn't work: https://code.visualstudio.com/remote/advancedcontainers/add-nonroot-user
RUN groupadd -g 1000 cora \
    && useradd -m -u 1000 -g cora cora \
    # Allow the user to install packages
    && chmod -R a+rwx /usr/local /usr/include/python3.11
USER cora:cora
WORKDIR /home/cora/workspace

# Install pip and setuptools first
RUN python -m pip install --upgrade pip setuptools wheel

# Install UV package manager using pip (more reliable method for Docker)
RUN python -m pip install uv

# Add UV to PATH and set environment variables for Hopper GPUs
ENV PATH="$PATH:/home/cora/.local/bin" \
    # Prevent JAX from allocating 90% of GPU memory:
    XLA_PYTHON_CLIENT_PREALLOCATE="false" \
    # Set XLA version to match CUDA driver for GH200
    XLA_CUDA_VERSION="12.2.0" \
    # Enable tensor cores on Hopper
    CUDA_DEVICE_MAX_CONNECTIONS=1

# Copy the entire project
COPY --chown=cora:cora . .

# Install common dependencies first
RUN python -m uv pip install tomli matplotlib pytest pytest-randomly pytest-cov pytest-xdist

# Install PyTorch with CPU support
RUN python -m uv pip install --index-url https://download.pytorch.org/whl/cpu torch torchvision torchaudio

# For GH200, we need to use specific JAX builds
# First uninstall any existing JAX installations that might conflict
RUN python -m uv pip uninstall -y jax jaxlib || true

# Install JAX with CUDA support for Hopper GPUs
# JAX 0.5.2 has proper Hopper support
# This is the only JAX installation - it will not be overridden later
# as we explicitly exclude it from the requirements.txt generation
RUN python -m uv pip install "jax[cuda12]==0.5.2" -f https://storage.googleapis.com/jax-releases/jax_cuda_releases.html

# Create simple scripts to extract dependencies with proper version format
RUN echo 'import tomli\n\ndef convert_version(v):\n    if v.startswith("^"):\n        return ">=" + v[1:]\n    return v\n\nwith open("pyproject.toml", "rb") as f:\n    config = tomli.load(f)\n\ndeps = [(k, convert_version(v)) for k, v in config["tool"]["poetry"]["dependencies"].items() \n       if k not in ["python", "jax", "jaxlib", "torch", "torchvision", "torchaudio", "matplotlib"]]\n\nwith open("requirements.txt", "w") as out:\n    out.write("\\n".join([f"{k}{v}" for k, v in deps]))' > extract_deps.py \
    && echo 'import tomli\n\ndef convert_version(v):\n    if v.startswith("^"):\n        return ">=" + v[1:]\n    return v\n\nwith open("pyproject.toml", "rb") as f:\n    config = tomli.load(f)\n\ndev_deps = [(k, convert_version(v)) for k, v in config["tool"]["poetry"]["group"]["dev"]["dependencies"].items() \n           if k not in ["pytest", "pytest-randomly", "pytest-cov", "pytest-xdist"]]\n\nwith open("dev-requirements.txt", "w") as out:\n    out.write("\\n".join([f"{k}{v}" for k, v in dev_deps]))' > extract_dev_deps.py

# Install remaining dependencies from pyproject.toml
RUN python -m pip install tomli \
    && python extract_deps.py \
    && python -m uv pip install -r requirements.txt \
    && python extract_dev_deps.py \
    && python -m uv pip install -r dev-requirements.txt

# Install local package in development mode
RUN python -m uv pip install -e ./



